# 投资组合子模块架构与数据结构评审（Ledger-first）

> 基于你上传的《Portfolio——Ledger-first 设计与落地说明》整理：现有亮点、主要问题/风险、改进建议与必要测试清单。  
> 目标：在尽量不推翻当前方案的前提下，提升可复算性、可对账性与可演进性。

---

## 1. 总体评价

你的总体方向是合理的：

- **Ledger-first**：以统一流水作为真相源（source of truth），指标与报表可追溯、可回放。
- **业务库与行情缓存库拆分**：业务数据与行情/缓存解耦，有利于本地应用的稳定性与数据治理。
- **幂等导入 + 软删除**：利于重复导入、撤销、回放以及审计。

---

## 2. 亮点（建议保留并强化）

1. **统一流水表覆盖面足够**：用单表承载 trade / cash / fee / tax / dividend / adjustment / corporate_action 等事件，便于演进。
2. **幂等与软删除**：按 `(portfolio_id, source, external_id)` 去重，`deleted_at` 软删除策略利于导入与回滚。
3. **baseline 迁移务实**：用 system baseline 将旧 `positions` 迁移到 ledger，有利于平滑过渡。

---

## 3. 主要问题/风险与建议（按优先级）

### A. 事件排序不足（高优先级）

**问题**
- 仅有 `trade_date (YYYY-MM-DD)` 难以稳定表达日内多笔交易顺序。
- 影响成本确认（尤其未来支持 FIFO/税务口径）、对账一致性与可审计性。

**建议**
- 增加 `event_ts`（ISO8601，建议 UTC 存储）用于排序；或增加 `sequence` 整型作为同日稳定序。
- `trade_date` 保留用于聚合和估值日，但引擎以 `event_ts/sequence` 排序为准。

---

### B. trade 事件的现金腿表达不完整（高优先级）

**问题**
- trade 现金流若隐含由 `quantity*price±fee±tax` 推导，会强依赖“币种一致/费用币种一致”等假设。
- 影响现金余额复算、IRR/MWR 的现金流序列、跨币种交易与导入对账。

**建议（择一）**
1. **推荐：显式现金腿（更 ledger 化）**  
   - trade 也写 `cash_amount`（买入为负、卖出为正），并明确其币种为 `cash_currency`。
   - `price` 作为成交价审计字段，现金以 `cash_amount` 为准。
2. **保守：继续推导现金腿，但补足币种规则**  
   - 明确 `price_currency`（或规定 price 永远等同 `cash_currency`）。  
   - 费用/税费也应明确币种（否则跨币种会困难）。

---

### C. 仅用 symbol 引用标的的长期稳定性（高优先级）

**问题**
- symbol 难以覆盖：同名不同市场、代码变更/退市、更名、非标准 ticker（基金/加密）。
- 长期会影响导入匹配与历史回放一致性。

**建议（最小改动）**
- 在 `ledger_entries` 增加 `instrument_id`（稳定 ID），计算以 `instrument_id` 为准。
- `symbol` 保留为展示/导入原文冗余字段。
- 若暂不做跨库外键，可在业务库加 `portfolio_instruments` 映射表（portfolio 内部稳定 id → symbol/市场/别名）。

---

### D. 数值精度策略不明确（高优先级）

**问题**
- SQLite REAL/浮点可能导致累计误差，最终表现为：对账失败、PnL 漂移、回放不一致。

**建议**
- 金额类（现金、费用、税费）优先采用 **最小货币单位整数** 存储（minor units）：如 cents。
- 数量/价格采用定点策略：  
  - 方案 1：应用层 Decimal（字符串写入 NUMERIC）；  
  - 方案 2：`value_int + scale`（定点整数）。
- 至少保证：导入→保存→导出→再导入不会出现数值漂移。

---

### E. 不引入 account_id 的可行性与演进风险（中高优先级）

**问题**
- MVP 可行，但后续多券商/多钱包/多现金池、划转、对账会遇到瓶颈。

**建议（最小改动）**
- 增加 `account_key`（nullable string）作为扩展钩子，先不在 UI 暴露。
- 或引入轻量 `accounts` 表（默认只有一个 `default`），不强迫用户配置。

---

### F. adjustment / corporate_action 语义边界与可计算性（中优先级）

#### F1. adjustment：基线还是增量？
**问题**
- baseline adjustment 与普通 adjustment 混用时，容易产生重复叠加或语义不清。

**建议**
- 在 `meta_json` 明确 `adjustment_mode: "absolute" | "delta"`（baseline 为 absolute）。
- 引擎回放遇到 absolute 时：按规则“重置”或“从该日作为新锚点”。

#### F2. corporate_action：建议标准化 meta 与展开策略
**问题**
- 公司行为放 meta 很灵活，但需要尽早约定标准字段与处理方式，否则很难长期维护。

**建议**
- 标准化 meta：如 split ratio、生效日、现金选择权等。
- 明确处理策略：
  1) **运行时展开**：计算时将 corporate_action 转为对持仓/成本的变换（推荐 MVP）；  
  2) **写入派生流水**：将公司行为展开为系统生成的多条 ledger_entries（更利于审计/对账，但复杂度更高）。

---

### G. 约束与校验尽量下沉到 DB（中优先级）

**问题**
- 仅在 IPC/服务层校验，未来容易被脚本、调试或批导写入“坏数据”。

**建议**
- 使用 SQLite `CHECK` 约束实现“按 event_type 字段依赖”与取值范围（非空、正负、互斥等）。
- 必要时使用 trigger（更强但更复杂）。

---

## 4. 建议的最小改动清单（低成本高收益）

按优先级建议如下：

1. **新增排序字段**：`event_ts`（或 `sequence`）。  
2. **trade 显式现金腿**：trade 也写入 `cash_amount` 与币种规则。  
3. **引入 instrument_id**：计算引擎以稳定 ID 为准。  
4. **金额定点化**：现金/费用/税费优先改为 minor units。  
5. **预留 account_key**：nullable，暂不影响现有 UI。

---

## 5. 必要测试清单（建议最少要有）

### 5.1 回放一致性测试（必须）
**目的**：验证 ledger-first 的确定性。
- 同一批 ledger_entries，重复回放 N 次（如 100 次），输出的：
  - 各标的持仓数量
  - 平均成本/成本基
  - 现金余额（按币种）
  - 已实现/未实现盈亏  
  必须逐字段一致（尤其在浮点/排序问题上能立刻暴露）。

### 5.2 导入幂等测试（必须）
**目的**：验证重复导入不会重复记账。
- 同一账单导入两次，ledger_entries 不得新增重复事件（依赖 `(portfolio_id, source, external_id)`）。
- 删除/撤销后再导入：应可恢复一致结果（结合 `deleted_at` 策略）。

### 5.3 baseline 不重叠测试（必须）
**目的**：验证 baseline upsert 与引擎语义不会造成“翻倍”。
- positions → baseline 写入 → 再导入/再编辑 → 回放  
  结果不得出现持仓重复叠加。
- 验证 `adjustment_mode=absolute` 的重置逻辑（如采用该建议）。

### 5.4 日内多笔交易顺序测试（强烈建议）
**目的**：验证新增 `event_ts/sequence` 的必要性与正确性。
- 同标的一天内多笔买卖，验证：
  - 平均成本
  - 已实现盈亏  
  在不同排序下会产生差异；引擎必须稳定且与导入源一致。

### 5.5 跨币种交易与汇兑损益测试（如支持多币种）
**目的**：验证显式现金腿与汇率规则。
- 买卖与费用币种不一致时，现金与估值应可复算。
- 汇率缺失时的处理（回填/报错/标记不可估值）要可测试。

---

## 6. 建议的演进路线（可选）

1. MVP：trade/cash/dividend/fee/tax + positions 回放 + 今日估值  
2. 引入历史估值（按日）与净值曲线  
3. TWR/MWR（至少一个）与分红/费用拆分  
4. 目标配置 + 偏离提示  
5. 导入对账与自动行情/汇率数据管道  
6. 公司行为/税务/多账户等进阶能力

---

## 7. 结论

当前架构的核心理念正确；建议优先补齐“排序、现金腿、标的稳定 ID、精度策略、账户扩展钩子”这五项，能在很小成本下显著降低未来迁移与对账风险，并使收益率与报表能力更容易落地。
