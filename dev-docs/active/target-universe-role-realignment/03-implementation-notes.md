# 03 Implementation Notes

- 2026-02-19: 创建任务包并冻结目标、范围、DoD。
- 2026-02-19: Shared 契约升级：
  - `AssetClass` 扩展为 `stock/etf/futures/spot/cash`。
  - `UniversePoolBucketId` 变更为 `cn_a/etf/metal_futures/metal_spot`。
  - 新增 Target Task 类型与 IPC：matrix config / preview coverage / list status / run materialization。
- 2026-02-19: Backend 存储升级：
  - `market-cache.sqlite` 新增 `target_task_status` 与 `target_materialization_runs`。
  - `analysis.duckdb` 新增 `futures_daily_ext` / `spot_sge_daily_ext` / `futures_contract_meta` / `spot_sge_contract_meta`，并扩展 `instrument_meta` 列。
- 2026-02-19: Universe ingest 升级：
  - 目录同步新增 futures/spot 标的（Tushare `fut_basic` / `sge_basic`）。
  - 每日批量新增 `fut_daily` / `fut_settle` / `sge_daily` 写入逻辑。
  - 运行元信息增加 futures/spot 计数。
  - 金属接口权限不足时降级为空批次（仅告警，不阻断 stock/etf 主流程）。
- 2026-02-19: Target ingest 主路径切换：
  - 以 `materializeTargetsFromSsot` 作为主逻辑，写入任务状态并同步 market-cache。
  - Orchestrator 在 targets job 前触发一次 universe prewarm（`targets_ssot_prewarm`）。
- 2026-02-19: 破坏性配置切换：
  - 配置输入出现 `precious_metal` 时直接报错，不做兼容映射。
  - frontend bucket 标签同步更新为“金属期货/金属现货（SGE）”。
- 2026-02-19: Target 缺口回补链路补齐：
  - `runTargetsIngest` 改为两阶段：先 SSOT 物化并记录 missing，再按 `defaultLookbackDays` 定向回补，再二次物化刷新状态。
  - 回补默认窗口读取 `target_task_matrix_config_v1.defaultLookbackDays`（默认 180 天）。
  - `ingest_runs` 的 `errors` 改为不可恢复错误口径；missing 不再直接计入 errors。
  - run meta 追加 `backfill.latencyMs`，用于追踪首次补齐延迟。
- 2026-02-19: 写入统计口径修正：
  - `materializeTargetsFromSsot` 新增 `insertedRows/updatedRows/missingSymbols` 输出，按主键存在性计算新增/更新。
  - DuckDB upsert 统一返回 inserted/updated 计数，Universe 跑批改为真实 upsert 统计。
- 2026-02-19: 交易日历 market 口径扩展：
  - `ensureTradingCalendars` 按 `CN_EQ/CN/SHFE/DCE/CZCE/CFFEX/INE/GFEX/SGE` 批量刷新到 `market-cache`.
  - Universe 写 DuckDB 日历改为多 market 同步，`trade_calendar` 覆盖交易所口径。
  - Equity 日期决策改为优先 `CN_EQ`，回退 `CN`，保证旧数据可读。
- 2026-02-19: 前端数据管理页补齐双池控制面板：
  - 新增“目标任务矩阵（SSOT-first）”面板，支持模块开关、回补窗口、覆盖率预览、状态筛选、手动物化。
  - 启用并接线“全量池配置”面板，恢复 `metal_futures/metal_spot` 的可视化配置入口。
