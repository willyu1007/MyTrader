# 投资组合模块完善 - Roadmap

## Goal
把“投资组合”做成可以日常高频使用的核心面板：数据口径清晰、计算可复现、结果可追溯、操作可回滚；并与行情/导入/自动拉取的数据管道形成闭环。

## 核心能力（对齐清单）
1. 资产与账户
2. 交易流水（含费用/税费/分红等）
3. 持仓调整（手工修正、调仓、拆分/合并等）
4. 持仓计算（从流水/调整推导“当前持仓”与历史持仓）
5. 估值（按价格/汇率/公司行为口径）
6. 收益率（TWR/MWR 等）
7. 归因分析（贡献/归因方法可迭代）
8. 现金流（入金/出金/现金余额）
9. 目标配置与再平衡（漂移、建议交易清单）
10. 报表（快照、导出、对账）
11. 风险指标与回撤（最大回撤、波动率、集中度等）
12. 公司行为（分红、送转、拆合股、配股等）
13. 数据管道（行情/公司行为/汇率/交易日历等数据源 + 质量/版本/追溯）

## 功能分组（领域模型）
为后续逐项讨论与实现，把能力按“依赖关系”分层：
- **数据层（Data）**：标的注册表、行情/公司行为/汇率/交易日历数据源、导入与自动拉取、数据质量与追溯
- **流水层（Ledger）**：交易流水、费用税费、现金流、公司行为事件（可作为流水的一类事件）
- **持仓引擎（Position Engine）**：从流水/调整生成“当前持仓/历史持仓/成本基础/已实现与未实现”
- **估值与收益（Valuation & Performance）**：估值、收益率口径、基准对比
- **分析层（Analytics）**：归因（贡献/Brinson/因子等分阶段）、风险指标与回撤
- **目标配置（Allocation）**：目标配置、漂移监控、再平衡建议与执行前检查
- **输出层（Reporting）**：快照、对账、导出、复盘报告

## 顶层 Tabs（已对齐）
> 数据不作为顶层 Tab：以右上角“数据状态”全局入口呈现（可解释/可控/可修复）。

投资组合模块顶层 Tabs（从左到右）：
1. **总览**
   - 总资产/现金/当日变动、关键预警、数据更新时间（as-of）、快捷动作（刷新/导入/目标配置入口）
2. **持仓**
   - 当前持仓（数量/成本/现价/市值/权重/PnL）、缺失/过期数据标注、一键修复、持仓调整入口
3. **交易**
   - 交易流水（买卖/费用税费/分红/调整/公司行为事件）、现金流（入金/出金/余额）、对账
4. **收益**
   - 收益率（TWR/MWR、区间收益）、收益拆分/贡献（归因分阶段迭代）、基准对比
5. **风险**
   - 风险指标与回撤（集中度、波动、最大回撤、风险规则命中），与持仓/收益联动定位
6. **目标配置**
   - 目标权重、漂移、再平衡建议清单（可交易性/风险/现金检查）
7. **公司行为**
   - 公司行为事件查看与校正（分红、拆合股等），影响追溯到持仓/成本/收益

### 全局入口：数据状态（右上角）
- 数据源状态、覆盖率、缺失/过期/异常提示
- 导入（CSV 等）、手动拉取、自动拉取范围（auto_ingest）与最近结果/日志
- 标的注册表（symbol 作为全局键值）

## 当前实现状态（与本任务的连接点）
- 已有：组合/持仓 CRUD、估值快照（基于最新价格）、敞口/风险阈值、CSV 导入、Tushare 拉取与自动拉取调度器、全局标的注册表雏形（market-cache 的 `instruments` + `auto_ingest`）。
- 缺口：交易流水/现金流/公司行为 -> 持仓引擎 -> 收益率/归因/风险曲线 -> 目标配置/再平衡 -> 报表（这是后续实现的主链路）。

## Decisions（已确认）
- **真相来源：以交易流水推导为主**（ledger-first）。持仓/现金/收益等均由引擎从流水计算；“持仓调整”视为一种特殊流水/事件，保证可追溯与可回放。
- **交易方向：使用 `buy/sell` 字段**（不再用数量正负号表达方向）。
- **成本法（MVP）：均价法**（后续可扩展 FIFO/LIFO/lot）。
- **不需要多账户/子账户**（流水与现金以组合维度组织）。

## Open questions（后续逐功能对齐时优先回答）
1. **收益率口径**：TWR、MWR 是否都要；基准/指数如何配置？
2. **公司行为处理范围**：先做分红/拆合股，还是一步到位覆盖更多事件？
3. **多币种与汇率**：是否纳入本任务主线；汇率数据源与追溯策略？
4. **数据管道的 DoD**：什么叫“数据可靠”？（缺失/过期提示、可追溯字段、质量校验）

## 后续讨论顺序（建议）
为了让 UI/UX 与数据语义一致，建议按依赖顺序讨论与落地：
1. 数据层：标的/行情/公司行为/汇率/日历 的最小可用数据模型 + 追溯字段
2. 流水层：交易流水与现金流的字段/口径/导入方式
3. 持仓引擎：从流水推导持仓（含调整/公司行为影响）
4. 估值与收益：估值口径、TWR/MWR、区间计算与展示
5. 分析：归因（先贡献）、风险指标与回撤
6. 目标配置：目标权重/漂移/再平衡建议清单
7. 报表：快照与导出/对账/复盘归档

## Verification（验收与验证）
- `pnpm typecheck`
- 手工用例（至少）：
  - 无行情/部分行情/全行情时：估值与 as-of 提示清晰、可一键补齐
  - 有流水/无流水两种模式下：持仓结果可解释、口径一致
  - 公司行为发生时：持仓/成本/收益的处理可追溯

## Risks & mitigations
| 风险 | 影响 | 缓解 |
|---|---:|---|
| 口径（成本/收益/公司行为）不统一导致用户误判 | 高 | 先定“口径字典”，UI 明示；每个指标都能追溯输入与版本 |
| 先做 UI 后做引擎导致返工 | 高 | 先对齐数据语义与最小数据模型，再做 UI 细节 |
| 多币种/汇率引入复杂依赖 | 中-高 | 先把结构留好；需要时单独定义 FX 数据源与追溯策略 |
