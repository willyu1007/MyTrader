# 投资组合模块完善 - Roadmap

## Goal
把“投资组合”做成可以日常高频使用的核心面板：数据口径清晰、计算可复现、结果可追溯、操作可回滚；并与行情/导入/自动拉取的数据管道形成闭环。

## 核心能力（对齐清单）
1. 资产与账户
2. 交易流水（含费用/税费/分红等）
3. 持仓调整（手工修正、调仓、拆分/合并等）
4. 持仓计算（从流水/调整推导“当前持仓”与历史持仓）
5. 估值（按价格/汇率/公司行为口径）
6. 收益率（TWR/MWR 等）
7. 归因分析（贡献/归因方法可迭代）
8. 现金流（入金/出金/现金余额）
9. 目标配置与再平衡（漂移、建议交易清单）
10. 报表（快照、导出、对账）
11. 风险指标与回撤（最大回撤、波动率、集中度等）
12. 公司行为（分红、送转、拆合股、配股等）
13. 数据管道（行情/公司行为/汇率/交易日历等数据源 + 质量/版本/追溯）

## 功能分组（领域模型）
为后续逐项讨论与实现，把能力按“依赖关系”分层：
- **数据层（Data）**：标的注册表（稳定 ID + symbol/别名）、行情/公司行为/汇率/交易日历数据源、导入与自动拉取、数据质量与追溯
- **流水层（Ledger）**：交易流水、费用税费、现金流、公司行为事件（含事件排序、现金腿、币种/精度策略）
- **持仓引擎（Position Engine）**：从流水/调整生成“当前持仓/历史持仓/成本基础/已实现与未实现”
- **估值与收益（Valuation & Performance）**：估值、收益率口径、基准对比
- **分析层（Analytics）**：归因（贡献/Brinson/因子等分阶段）、风险指标与回撤
- **目标配置（Allocation）**：目标配置、漂移监控、再平衡建议与执行前检查
- **输出层（Reporting）**：快照、对账、导出、复盘报告

## 顶层 Tabs（已对齐）
> 数据不作为顶层 Tab：以右上角“数据状态”全局入口呈现（可解释/可控/可修复）。

投资组合模块顶层 Tabs（从左到右）：
1. **总览**
   - 总资产/现金/当日变动、关键预警、数据更新时间（as-of）、快捷动作（刷新/导入/目标配置入口）
2. **持仓**
   - 当前持仓（数量/成本/现价/市值/权重/PnL）、缺失/过期数据标注、一键修复、持仓调整入口
3. **交易**
   - 交易流水（买卖/费用税费/分红/调整/公司行为事件）、现金流（入金/出金/余额）、对账
4. **收益**
   - 收益率（TWR/MWR、区间收益）、收益拆分/贡献（归因分阶段迭代）、基准对比
5. **风险**
   - 风险指标与回撤（集中度、波动、最大回撤、风险规则命中），与持仓/收益联动定位
6. **目标配置**
   - 目标权重、漂移、再平衡建议清单（可交易性/风险/现金检查）
7. **公司行为**
   - 公司行为事件查看与校正（分红、拆合股等），影响追溯到持仓/成本/收益

### 全局入口：数据状态（右上角）
- 数据源状态、覆盖率、缺失/过期/异常提示
- 导入（CSV 等）、手动拉取、自动拉取范围（auto_ingest）与最近结果/日志
- 标的注册表（稳定 ID + symbol/别名）

## 当前实现状态（与本任务的连接点）
- 已有：组合/持仓 CRUD、估值快照（基于最新价格）、敞口/风险阈值、CSV 导入、Tushare 拉取与自动拉取调度器、全局标的注册表雏形（market-cache 的 `instruments` + `auto_ingest`）。
- 缺口：交易流水/现金流/公司行为 -> 持仓引擎 -> 收益率/归因/风险曲线 -> 目标配置/再平衡 -> 报表（这是后续实现的主链路）。

## Decisions（已确认）
- **真相来源：以交易流水推导为主**（ledger-first）。持仓/现金/收益等均由引擎从流水计算；“持仓调整”视为一种特殊流水/事件，保证可追溯与可回放。
- **交易方向：使用 `buy/sell` 字段**（不再用数量正负号表达方向）。
- **成本法（MVP）：均价法**（后续可扩展 FIFO/LIFO/lot）。
- **不需要多账户/子账户**（流水与现金以组合维度组织，但预留 `account_key`）。

## Open questions（后续逐功能对齐时优先回答）
1. **收益率口径**：TWR、MWR 是否都要；基准/指数如何配置？
2. **公司行为处理范围**：先做分红/拆合股，还是一步到位覆盖更多事件？
3. **多币种与汇率**：是否纳入本任务主线；汇率数据源与追溯策略？
4. **数据管道的 DoD**：什么叫“数据可靠”？（缺失/过期提示、可追溯字段、质量校验）
5. **事件排序与现金腿**：`event_ts/sequence`、`cash_amount` 与币种字段如何定？
6. **标的稳定 ID**：`instrument_id` 与 `symbol`/别名的映射策略？
7. **精度策略**：金额/价格/数量的定点化与舍入规则？

## 后续讨论顺序（建议）
为了让 UI/UX 与数据语义一致，建议按依赖顺序讨论与落地：
1. 数据层：标的/行情/公司行为/汇率/日历 的最小可用数据模型 + 追溯字段
2. 流水层：交易流水与现金流的字段/口径/导入方式
3. 持仓引擎：从流水推导持仓（含调整/公司行为影响）
4. 估值与收益：估值口径、TWR/MWR、区间计算与展示
5. 分析：归因（先贡献）、风险指标与回撤
6. 目标配置：目标权重/漂移/再平衡建议清单
7. 报表：快照与导出/对账/复盘归档

## Verification（验收与验证）
- `pnpm typecheck`
- 手工用例（至少）：
  - 无行情/部分行情/全行情时：估值与 as-of 提示清晰、可一键补齐
  - 有流水/无流水两种模式下：持仓结果可解释、口径一致
  - 公司行为发生时：持仓/成本/收益的处理可追溯

## Risks & mitigations
| 风险 | 影响 | 缓解 |
|---|---:|---|
| 口径（成本/收益/公司行为）不统一导致用户误判 | 高 | 先定“口径字典”，UI 明示；每个指标都能追溯输入与版本 |
| 先做 UI 后做引擎导致返工 | 高 | 先对齐数据语义与最小数据模型，再做 UI 细节 |
| 多币种/汇率引入复杂依赖 | 中-高 | 先把结构留好；需要时单独定义 FX 数据源与追溯策略 |

## 后续执行计划（按功能/依赖顺序，2026-01-15 更新）

### 目标
- 在已完成“收益口径（TWR/MWR）+ 区间选择 + 收益曲线”的基础上，推进分析层、目标配置与报表的最小闭环。

### 非目标
- 本轮不做高级归因模型（Brinson/多因子）与多币种/汇率的全量接入（先保留扩展点）。
- 不做复杂策略回测与高级预警系统。

### 开放问题与假设
#### 已对齐（2026-01-15）
- 公司行为范围：分红、拆股/合股必须支持；同时支持“关键决策/组织架构调整/政策支持”等信息型公司行为，仅用于展示/追溯/记录，不影响持仓与收益。
- 多币种/汇率：不纳入本轮主线（保留扩展点）。
- 事件排序：接受 `event_ts` -> `trade_date + sequence` -> `created_at/id` 的稳定顺序；导入时 `sequence` 强制要求。

#### 数据质量 DoD（已确认参考值）
- 完整性：`event_type`/`trade_date`/`portfolio_id` 等必填项不为空；`cash_amount` 有值则 `cash_currency` 必填；trade 必有 `cash_amount`。
- 覆盖率（按市值）：估值区间内价格覆盖率 >= 98% 视为可用；95%~98% 标记“可用但有缺口”；<95% 视为不可用并降级口径。
- 新鲜度：`price_date` 与 as-of 的间隔 <= 1 交易日（有交易日历）或 <= 3 自然日（无交易日历）视为“新鲜”；>5 自然日视为不可用。
- 可追溯：`source`/`external_id`/`meta_json` 有效，保证幂等导入与审计。
- 可复算：同一流水回放结果一致（持仓/现金/收益稳定）。

#### 事件排序与现金腿（已确认）
- 排序：`event_ts`（ISO8601，推荐 UTC）优先；若缺失，用 `trade_date` + `sequence`；仍缺失则用 `created_at/id` 作为稳定兜底。
- `sequence`：同日/同一时间多笔事件的稳定顺序键（导入必填）。
- 现金腿：trade 必须显式 `cash_amount` + `cash_currency`（买入 <0，卖出 >0）；fee/tax 必须 <0；dividend 必须 >0；cash 入金 >0/出金 <0；corporate_action 仅在有现金影响时填 `cash_amount`。
- 信息型公司行为（关键决策/组织架构调整/政策支持）不产生现金腿，默认不影响持仓/收益，仅用于展示与解释。

#### 假设（若未确认）
- A1: 分析层 v1 仅做“收益贡献归因 + 风险指标（波动/最大回撤/集中度）”，基准对比留到后续（风险：中）。
- A2: 目标配置/再平衡以“目标权重 + 漂移监控 + 建议交易清单”作为最小闭环（风险：中）。

### 里程碑
1. **Milestone 1: 数据/流水完整性确认与补齐**
   - Deliverable: 现金流与公司行为事件的最小覆盖范围确认，事件排序/现金腿规则明确。
   - Acceptance: 可用输入能稳定驱动持仓引擎与收益口径。
2. **Milestone 2: 分析层 v1**
   - Deliverable: 收益贡献归因 + 风险指标 v1（波动/最大回撤/集中度）。
   - Acceptance: UI 可解释、可追溯到输入数据。
3. **Milestone 3: 目标配置/再平衡 v1**
   - Deliverable: 目标权重配置、漂移监控、再平衡建议清单。
   - Acceptance: 与持仓/收益联动定位，能形成操作建议。
4. **Milestone 4: 报表/导出 v1**
   - Deliverable: 快照、对账、导出最小链路。
   - Acceptance: 支持手工复核与归档。

### 分阶段计划（宏观）
#### Phase 0 - Discovery（如需要）
- Objective: 盘点当前 ledger/position/performance 的覆盖范围与缺口。
- Deliverables:
  - 缺口清单与数据口径确认笔记。
- Verification:
  - 关键口径与事件规则已得到确认。
- Rollback:
  - N/A（无代码变更）。

#### Phase 1 - 分析层 v1
- Objective: 建立最小可用的收益贡献归因与风险指标。
- Deliverables:
  - 贡献归因口径与计算结果展示。
  - 风险指标（波动/最大回撤/集中度）与解释文案。
- Verification:
  - typecheck/build 通过；关键指标可复算。
- Rollback:
  - 关闭分析入口或回退至仅收益展示。

#### Phase 2 - 目标配置/再平衡 v1
- Objective: 目标权重与漂移监控形成操作建议。
- Deliverables:
  - 目标配置入口与漂移提示。
  - 再平衡建议清单（不含自动执行）。
- Verification:
  - 配置变更能在界面稳定呈现并可追溯。
- Rollback:
  - 退回只读配置或隐藏建议模块。

#### Phase 3 - 报表/导出 v1
- Objective: 形成对账与归档的最小报表链路。
- Deliverables:
  - 快照、对账视图与导出（CSV）。
- Verification:
  - 手工复核流程完整可用。
- Rollback:
  - 仅保留快照，不开放导出。

### 验证与验收标准
- Build/typecheck:
  - `pnpm typecheck`
- Manual checks:
  - 收益/分析/风险/配置/报表入口可用，关键指标可追溯。
- Acceptance criteria:
  - 分析层指标可解释且与基础数据一致。
  - 目标配置与漂移提示稳定。
  - 报表支持对账与归档。

### 风险与缓解
| 风险 | 概率 | 影响 | 缓解 | 发现 | 回滚 |
|---|---:|---:|---|---|---|
| 数据口径不统一导致分析/风险失真 | 中 | 高 | 先完成口径与事件规则确认 | 指标异常/无法复算 | 关闭分析入口 |
| 公司行为或现金腿处理不一致 | 中 | 中 | 先定义最小覆盖与排序规则 | 回测/复算不一致 | 回退至收益总览 |
| 目标配置与建议可用性不足 | 中 | 中 | 以只读建议起步 | 反馈不稳定 | 隐藏建议模块 |

## 可选详细文档布局（约定）
如需维护详细 dev-docs 文档包，约定如下：

```
dev-docs/active/portfolio-upgrade/
  roadmap.md              # Macro-level planning (plan-maker)
  00-overview.md
  01-plan.md
  02-architecture.md
  03-implementation-notes.md
  04-verification.md
  05-pitfalls.md
```

Suggested mapping:
- Roadmap 的 Goal/Non-goals/Scope -> `dev-docs/active/portfolio-upgrade/00-overview.md`
- Roadmap 的 Milestones/Phases -> `dev-docs/active/portfolio-upgrade/01-plan.md`
- Roadmap 的 high-level architecture -> `dev-docs/active/portfolio-upgrade/02-architecture.md`
- 执行过程中的决策/偏差 -> `dev-docs/active/portfolio-upgrade/03-implementation-notes.md`
- 验证记录 -> `dev-docs/active/portfolio-upgrade/04-verification.md`

## To-dos
- [ ] 确认开放问题
- [ ] 确认里程碑顺序与 DoD
- [ ] 确认验证/验收与回滚策略
