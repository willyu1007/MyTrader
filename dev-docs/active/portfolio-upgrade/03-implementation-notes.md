# 03 Implementation Notes

## Status
- Current status: in_progress
- Last updated: 2026-01-14

## Notes (append-only)
- 2026-01-14：确认顶层 Tabs 为「总览/持仓/交易/收益/风险/目标配置/公司行为」，数据入口改为右上角全局“数据状态”。
- 2026-01-14：确认 ledger-first（以流水推导为真相源）；交易方向用 `buy/sell`；成本法（MVP）用均价；不做多账户/子账户。
- 2026-01-14：新增 `ledger_entries`（business schema v3）+ IPC（`window.mytrader.ledger.*`），用于后续交易流水/现金流等能力落地。
- 2026-01-14：实现 `positions -> ledger` 基线同步（含 schema v3 升级时 backfill、持仓增删改与 CSV 导入同步；`source=system` + `externalId=baseline:*`）。
- 2026-01-14：新增根目录说明文档 `PORTFOLIO_LEDGER.md`；`pnpm typecheck` 通过。
- 2026-01-15：升级 business schema v4，补齐 `ledger_entries` 字段（`account_key/event_ts/sequence/instrument_id/price_currency`）与索引，新增 `portfolio_instruments` 映射表，并更新 ledger IPC 类型与校验规则。
- 2026-01-15：新增持仓引擎 v0（从流水推导持仓/成本/现金），`portfolio snapshot` 优先消费 ledger，按 `event_ts/sequence` 排序回放，并生成现金持仓快照。
- 2026-01-15：开始搭建投资组合 UI/UX 框架，新增顶部 7 个 Tab（总览/持仓/交易/收益/风险/目标配置/公司行为）并拆分总览/持仓视图。
- 2026-01-15：组合管理面板移动到「总览」Tab，Tab 样式改为顶部条形导航，增强选中态。
- 2026-01-15：修复快照的现金估值口径（现金按 1:1 计入市值/成本/PnL=0），并在无持仓流水但存在现金流水时合并输出现金持仓；trade 校验补齐 `cashAmount` 正负号；新增 `verify:position-engine` 回放一致性脚本（100 次随机乱序回放一致）。
- 2026-01-15：新增收益口径 v0：TWR（按外部现金流分期，缺行情时降级为 MWR/IRR），并在收益 Tab 展示口径、区间与年化/总收益；快照输出 `performance` 结构。
- 2026-01-15：新增收益区间选择与收益曲线：`portfolio.getPerformance` IPC 输出区间 TWR/MWR 与曲线（按行情日期+现金流日期拼接）；收益 Tab 支持 1M/3M/6M/1Y/YTD/全部范围切换。
- 2026-01-15：Phase 0 盘点（ledger/position/performance）完成。
  - 覆盖范围：`ledger_entries` 支持 trade/cash/fee/tax/dividend/adjustment/corporate_action，IPC CRUD 已落地；positions 可从流水回放（trade/adjustment）推导并合并现金；收益口径包含 TWR/MWR 与区间收益曲线；行情支持 CSV/Tushare 导入与按日价格查询。
  - 缺口清单：数据质量 DoD 尚未落地（缺失/过期/覆盖率提示、可追溯性指标、复算标记）；`sequence` 尚未在导入/IPC 强制必填；公司行为仅记录 meta，未形成标准 schema，拆股/合股等对持仓/成本/收益的影响尚未实现；独立 fee/tax 事件未与交易成本/收益归因联动；`instrument_id`/别名映射未接入 `portfolio_instruments`；估值/收益目前对行情缺失为“全或无”，未按覆盖率分级提示。
- 2026-01-15：落地数据质量 DoD v1（覆盖率/新鲜度/缺失标的提示）并在收益页展示；导入来源强制要求 `sequence`。
- 2026-01-15：公司行为 meta schema v1 落地（split/reverse_split/info）；拆股/合股对持仓数量与成本单价生效，并在估值/收益回放中应用。
- 2026-01-15：补齐交易 Tab 流水/现金流 UI（列表、筛选、手工新增/编辑/删除、公司行为 meta 输入、系统流水只读提示），并在新增/编辑后刷新快照。
- 2026-01-15：调整交易流水 UX（删除确认弹窗、通知 1 秒自动消失、首行新增按钮与折叠表单、字段中文化与问号提示）。
- 2026-01-15：进一步调整交易流水布局（首行移除 MVP/刷新、录入按钮右侧、表单上移、刷新图标挪入摘要行、时间段筛选、弹窗中文化与自动消失）。
- 2026-01-15：交易流水顶部压缩为两行布局（标题+日期区间/筛选+净流+刷新+录入）。
- 2026-01-15：交易流水顶部布局对齐截图（两行卡片式头部、移除只读提示、日期占位灰色）。
- 2026-01-15：交易流水顶部微调（日期区无外框/无图标、白底、去圆角、间距更紧、按钮更小）。
- 2026-01-15：交易流水头部细节调整（日期区背景与底色一致、交易类型筛选去框/缩小字体、净流去框）。
- 2026-01-15：开发模式自动解锁账号（无登录），解锁流程支持 dev bypass 并在无账号时创建开发账号。
- 2026-01-15：录入表单头部调整（保存/取消移至标题行右侧）、必填字段缺失提示改为暗红色、字段标题改为灰色以区分输入值。
- 2026-01-15：交易流水录入表单将“事件类型”移到标题行并补充说明提示；事件类型文案区分“交易（含费用/税费）”与“独立费用/税费”；新增多个字段的问号提示；说明提示改为悬停 0.5 秒显示。
- 2026-01-15：移除独立费用/税费事件入口（仅保留交易内费用/税费），事件类型下拉改为无背景框；录入表头取消“事件类型”文字与问号；新增自动计算费用/税费设置（费率/税率输入，0.5s 悬停提示沿用）。
- 2026-01-15：录入表单布局按截图分区重排（行情与标的/时间与排序/财务明细卡片），事件类型下拉保持无底色；表单容器改为直角边框。
- 2026-01-15：交易录入表单整体压缩（行距、区块间距、卡片内边距缩小；输入/下拉高度与字号缩小，并统一直角）。
- 2026-01-15：筛选下拉与事件类型下拉去黑底并增加左侧内边距，避免文字贴边。
- 2026-01-15：交易筛选下拉文案改为主色；录入表头移除可见“新增/编辑流水”文字，仅保留图标（文本隐藏）。
- 2026-01-15：录入区移除“行情与标的”标题；方向改为左右切换按钮；标的行改为 6 列单行布局。
- 2026-01-15：交易录入首行与第二行之间新增分隔线，并移除“时间与排序”标题行。
- 2026-01-15：录入表头与首行字段之间增加分隔线。
- 2026-01-15：交易录入将现金腿/费率/税率/费用/税费/外部标识移到代码下方一行；移除财务明细区块、现金币种与来源；费用/税费改为只读自动计算并与价格币种保持一致。
- 2026-01-15：交易日期/事件时间/排序序号/账户标识/备注 合并为单行布局（大屏 5 列）。
- 2026-01-15：交易录入现金腿改为自动计算（默认启用，手动编辑后停止自动并允许调整）；费率/税率写入本地缓存并在同类型流水中复用；费用/税费仅由费率/税率自动计算。
- 2026-01-15：现金腿自动计算改为包含费用/税费影响（买入=-(成交额+费税)，卖出=成交额-费税），手动修改仍可覆盖。
- 2026-01-15：录入展开区域背景色调亮（浅灰/更透明），与顶部区域区分。
- 2026-01-15：录入展开区域背景改为暖色调（浅琥珀色）。
- 2026-01-15：录入展开区域背景再调浅（浅琥珀色降低不透明度）。
- 2026-01-15：录入展开区域背景由偏红的暖色调整为中性浅石色，降低红感。
- 2026-01-15：录入展开区域背景改为浅青色，和现金流灰色区分。
- 2026-01-15：录入展开区域浅青背景加深，提高与现金流区分度。
- 2026-01-15：录入展开区域增加顶部分隔色条（加粗边框），进一步提升与下方区域区分度。
- 2026-01-15：录入展开区域分隔线加粗并加深颜色（更明显）。
- 2026-01-15：录入展开区域分隔线调整为左右与下方高亮，上方不显示分隔线。
- 2026-01-15：录入展开时禁用“录入”按钮并置灰，避免重复点击。
- 2026-01-15：交易流水日期筛选默认区间改为 2000-01-01 至 2099-12-31；去掉“开始/结束日期”文字并压缩顶部高度。
- 2026-01-15：交易流水日期筛选默认值固定为 2000-01-01/2099-12-31，切换组合时不再清空。
- 2026-01-15：交易日期输入加宽，避免默认日期被遮挡。
- 2026-01-15：公司行为表单移除下方详情区；“事件类型”移入与外部标识同一行；取消“信息”选项；拆股/合股改为“当前 1 股调整后变为多少股”输入并自动换算分子分母。
- 2026-01-15：交易流水 UI 将分红并入公司行为事件类型（录入与筛选合并显示），移除“调整”入口并标记历史记录。
- 2026-01-15：公司行为选择“分红”时，现金腿移动到事件类型右侧展示。
- 2026-01-15：分析层 v1 增加收益贡献（标的/资产类别、Top N 展示与展开）与风险指标（估值/TWR 波动率、最大回撤、年化切换），并在风险页展示 HHI 集中度阈值提醒。
- 2026-01-15：风险/贡献卡片底色由深蓝调为更浅的中性色，降低大面积深色背景带来的不适。
- 2026-02-05：落地“单一数据源（active）”规则：新增 `instrument_data_sources` 表，行情/日指标/资金流写入前检测源切换并清理旧域数据，避免同标的跨源混用。
- 2026-02-05：补充“行业/主题”语义投影：新增 Tag Facets（行业/主题/用户/其它），支持 `ind:sw:l1/l2/l3` 与 `theme:*` 命名空间，并在标的详情中展示行业/主题标签。
- 2026-02-05：新增 SW 行业层级表 `sw_industries`，维护 L1/L2 关系；标的详情增加“手动主题（THS）”选择（下拉选择、写入 `theme:manual:*`），并禁止手动输入 `theme:` 标签。
- 2026-02-05：新增“数据分析”视图（顶栏 nav），复用收益/贡献/风险分析组件；切换到该视图自动加载指定区间的 performance/analysis（与收益/风险 Tab 共用数据与切换逻辑），移除占位 Placeholder。
- 2026-02-05：明确 UI 边界：投资组合内收益/风险保留概要展示；贡献分解与风险拆解等详版分析收敛到「数据分析 -> 组合」。
- 2026-02-06：数据分析顶部场景切换样式对齐投资组合顶部 Tab（容器边框/背景、按钮激活态、图标与文字排布一致）。
- 2026-02-07：落地「数据分析 -> 个股」MVP：新增独立搜索/选股、区间切换、日线走势、关键指标（最新价/当日涨跌/区间收益/持仓成本）与分析明细（区间高低/OHLC/均量/标签/目标价）；数据加载与 market 视图解耦，避免互相依赖 activeView。
